# Installation: Prepare Nextcloud

Prerequisites:
- Make sure your Nextcloud url uses `https://`.
  - If you want to use a local Nextcloud instance with `http://` for testing, you need to apply another patch to your apps - see below. Do _not_ use a `http://` url in production.
- Make sure your Nextcloud instance has no pre-existing user accounts, groups or group folders that would conflict with entities created remotely by Drupal:
  - User accounts created by Drupal in Nextcloud will have 1:1 the same username as in Drupal. If such an account already exists in Nextcloud, Drupal will assume it is the same person that controls the Drupal account with the same name.
  - The `admin` user in Nextcloud will be identified with the `admin` user in Drupal. (This might change in future versions of this module.)
  - Groups generated by Drupal in Nextcloud usually have a machine name starting with `DRUPAL-GROUP-`. Such groups might exist as leftovers from a previous attempt to integrate with Drupal.
  - Group folders could conflict with existing folders in user directories.

Apps and patches:
- Install Nextcloud apps:
  - Install the `groupfolders` app, if you want to create document spaces for Drupal groups.
  - Install the `user_cas` app, if you want EU Login.
- Apply patches to Nextcloud apps:
  (See [resources/docker-image/build.patch.sh](resources/docker-image/build.patch.sh).)
  - Patch the `user_cas` app:
    - https://patch-diff.githubusercontent.com/raw/felixrupp/user_cas/pull/106.diff
    - https://patch-diff.githubusercontent.com/raw/felixrupp/user_cas/pull/108.diff
  - If your Nextcloud url uses `http://` instead of `https://` (only advised for testing purposes), you need to patch `user_cas/vendor/jasig/phpcas`:
    - `resources/docker-image/phpCAS.http.patch`

API user account:
- Log into Nextcloud as admin.
- Visit `/settings/users`.
- Click "New user" and create a user named e.g. "Drupal API user".
  - Add the user to the "admin" group.
  - Use a password generator to create the password. Store it in a safe place.
  - Leave other fields empty.
  - _Note: Currently it is possible that somebody would create a user account in Drupal with the same name as the API user, which would then be identified with the API user. A stable version of this module will need to prevent this._

### Optional Nextcloud apps

The following Nextcloud apps are useful for document management, but they are irrelevant for the Drupal integration:
- Use [Nextcloud Office ("richdocuments")](https://apps.nextcloud.com/apps/richdocuments) for co-editing on spreadsheets, presentations, rich text documents etc.
  This requires a Collabora server.
- Use [Full text search](https://apps.nextcloud.com/apps/fulltextsearch) to search documents by their contents instead of just their file names.
  This requires a search backend like Elastic Search, among other things.
