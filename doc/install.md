# Installation in an existing project

This section assumes that you have an existing Drupal website, and an existing Nextcloud instance.

## Prepare the Nextcloud instance

Prerequisites:
- Make sure your Nextcloud url uses `https://`.
  - If you want to use a local Nextcloud instance with `http://` for testing, you need to apply another patch to your apps - see below. Do _not_ use a `http://` url in production.
- Make sure your Nextcloud instance has no pre-existing user accounts, groups or group folders that would conflict with entities created remotely by Drupal:
  - User accounts created by Drupal in Nextcloud will have 1:1 the same username as in Drupal. If such an account already exists in Nextcloud, Drupal will assume it is the same person that controls the Drupal account with the same name.
  - The `admin` user in Nextcloud will be identified with the `admin` user in Drupal. (This might change in future versions of this module.)
  - Groups generated by Drupal in Nextcloud usually have a machine name starting with `DRUPAL-GROUP-`. Such groups might exist as leftovers from a previous attempt to integrate with Drupal.
  - Group folders could conflict with existing folders in user directories.

Apps and patches:
- Install Nextcloud apps:
  - Install the `groupfolders` app, if you want to create document spaces for Drupal groups.
  - Install the `user_cas` app, if you want EU Login.
- Apply patches to Nextcloud apps:
  (See [resources/docker-image/build.patch.sh](resources/docker-image/build.patch.sh).)
  - Patch the `user_cas` app:
    - https://patch-diff.githubusercontent.com/raw/felixrupp/user_cas/pull/106.diff
    - https://patch-diff.githubusercontent.com/raw/felixrupp/user_cas/pull/108.diff
  - If your Nextcloud url uses `http://` instead of `https://` (only advised for testing purposes), you need to patch `user_cas/vendor/jasig/phpcas`:
    - `resources/docker-image/phpCAS.http.patch`

API user account:
- Log into Nextcloud as admin.
- Visit `/settings/users`.
- Click "New user" and create a user named e.g. "Drupal API user".
  - Add the user to the "admin" group.
  - Use a password generator to create the password. Store it in a safe place.
  - Leave other fields empty.
  - _Note: Currently it is possible that somebody would create a user account in Drupal with the same name as the API user, which would then be identified with the API user. A stable version of this module will need to prevent this._

### Optional Nextcloud apps

The following Nextcloud apps are useful for document management, but they are irrelevant for the Drupal integration:
- Use [Nextcloud Office ("richdocuments")](https://apps.nextcloud.com/apps/richdocuments) for co-editing on spreadsheets, presentations, rich text documents etc.
  This requires a Collabora server.
- Use [Full text search](https://apps.nextcloud.com/apps/fulltextsearch) to search documents by their contents instead of just their file names.
  This requires a search backend like Elastic Search, among other things.


## Installation in Drupal

### Install the module(s)

Add the github repository as a repository in `composer.json`, and require the module package `openeuropa/poc_nextcloud`.

Optionally require the `drupal/group` module package.

Enable the modules you need:
- The base module `poc_nextcloud` is required to connect to Nextcloud and synchronize users.
- The submodule `poc_nextcloud_group_folder` is optional. It allows to link Drupal groups to Nextcloud group folders.
  - This requires the `group` module.
- The submodule `poc_nextcloud_demo` is only meant for demo and development purposes. It introduces configuration for group types, user roles and blocks. Typically an existing site will already have these, so it would be counter-productive to install this submodule. However, you can install it on a local test site as inspiration.


### Configure the Nextcloud connection

The Nextcloud credentials are sensitive information.

#### Using the configuration system (not recommended)

You _can_ store these values as configuration in the database.
There is no UI for this, instead you need to run `drush config-set`.

However, this method is not recommended, because the credentials will be copied to other instances of the website (acceptance, local etc), either through (sanitized or not) database dumps, or through config-sync.

This causes two problems:
- The credentials may leak to unauthorized parties.
- It becomes harder to have different values for different instances of the Drupal website, e.g. production vs acceptance vs local.

#### Using config overrides (semi recommended)

In your `sites/default/settings.php`, add these lines:
```php
// Configuration override for
// Credentials of the API user.
$config['poc_nextcloud.settings']['nextcloud_user'] = 'api_user';
$config['poc_nextcloud.settings']['nextcloud_pass'] = 'api_user_pass';
// Nextcloud URL for server-side API requests.
$config['poc_nextcloud.settings']['nextcloud_url'] = 'https://my.nextcloud.url/';
// Nextcloud URL for client-side links and redirects.
// In some scenarios this could be different from the server-side url.
$config['poc_nextcloud.settings']['nextcloud_web_url'] = 'https://my.nextcloud.url/';
// Encryption key to encrypt authorization cookies or tokens.
// This can be an arbitrary-length random string.
$config['poc_nextcloud.settings']['storage_encryption_key'] = 'W76apvVvJ8yVxt2oA3FLPgZK65rRLLZ5QA6MgsxZqLmeSXVQ';
```

This should be safe enough, if you exclude the settings.php from backups, and overall prevent unauthorized access.

#### Using config overrides + getenv() (recommended)

If you don't like to maintain settings.php directly, you can use environment variables to control these settings.

In your `sites/default/settings.php`, replace the literal values with `getenv()` calls.
You are free to choose different names for the env vars.

```php
// Configuration overrides for 'poc_nextcloud' module.
// Credentials of the API user.
// This can be 'admin', but it is recommended to created a dedicated user.
$config['poc_nextcloud.settings']['nextcloud_user'] = getenv('NEXTCLOUD_API_USER');
$config['poc_nextcloud.settings']['nextcloud_pass'] = getenv('NEXTCLOUD_API_PASS');
// Nextcloud URL for server-side API requests.
$config['poc_nextcloud.settings']['nextcloud_url'] = getenv('NEXTCLOUD_API_URL');
// Nextcloud URL for client-side links and redirects.
// In some scenarios this could be different from the server-side url.
$config['poc_nextcloud.settings']['nextcloud_web_url'] = getenv('NEXTCLOUD_WEB_URL');
// Encryption key to encrypt authorization cookies or tokens.
// This can be an arbitrary-length random string.
$config['poc_nextcloud.settings']['storage_encryption_key'] = getenv('NEXTCLOUD_CRYPT_SECRET');
```

## Site building in Drupal

### Configure user role

Create a user role named 'Nextcloud user'.
Grant the permission 'Have a Nextcloud account'.
Users with this role will have Nextcloud accounts created for them.

### Configure user display (optional)
In the user profile display, place the "Link to Nextcloud account" extra field.

### Place a block (optional)
In the blocks UI, place the "Link to Nextcloud documents".

### Create a group type (optional)
Enable the `group` module, if not done yet.
Create a new group type, or use an existing one.

Create a field 'Group folder' in the group type, with field type `poc_nextcloud_group_folder`.

### Configure group roles (optional)
Create group roles for the group type.
Assign permissions related to Nextcloud document.

## Use the module

### Users

Create users. Edit them, and:
- Assign the "Nextcloud user" role.
- Make sure the account is active.
- Make sure the account has a non-empty email address and username.
- _Beware of unconventional usernames. We have not yet explored the limitations of usernames in Nextcloud._

Observe users being created in Nextcloud.
These newly created Nextcloud accounts won't have a known password. Instead, there are two options for login:
- If you use the EU Login integration

### Groups and memberships
Create groups.

Add users to groups, and assign group roles.

Observe users and group folders being created in Nextcloud.

Log into Nextcloud with one of the user accounts, and
